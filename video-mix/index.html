<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>视频混音</title>
    <script src="../common/cos-js-sdk-v5.min.js"></script>
    <script src="../common/xml2json.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        padding: 20px;
        display: flex;
        justify-content: space-around;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="resourceFile">
        <div>源文件：</div>
        <video
          src="*******************************"
          width="570"
          height="450"
          controls
        ></video>
      </div>

      <div class="changeFile">
        <div>混音后视频：</div>
        <video id="changeFile-id" width="570" height="450"></video>
      </div>
    </div>
    <div style="margin-top: 20px">
      <button onclick="postTranscode()">进行视频混音</button>
      <span id="msg-text"></span>
    </div>

    <script>
      /*
        准备工作：
        1. 在cos控制台创建一个存储桶，可拿到存储桶名称和地域，即Bucket，Region。
        2. 进入存储桶配置页面，设置对应的跨域规则（简单调试可将来源Origin设置为*）。
        3. 进入访问管理控制台，获取API密钥，即SecretId，SecretKey。
      */

      // 注意：以下初始化方式仅供联调测试使用，为了安全起见，请勿在生产环境直接暴露密钥。
      // 生产环境请参考各语言SDK签名实现。https://cloud.tencent.com/document/product/436/7778#sdk-.E7.AD.BE.E5.90.8D.E5.AE.9E.E7.8E.B0

      // 密钥请在访问管理控制台获取。https://console.cloud.tencent.com/cam/capi
      const cos = new COS({
        SecretId: "AKID*******",
        SecretKey: "**********",
      });

      // 存储桶配置请在cos控制台获取。https://console.cloud.tencent.com/cos/bucket
      // 格式参考：Bucket: 'abc-1250000000', Region: 'ap-shanghai'
      // 上传音视频文件
      const config = {
        // 需要替换成您自己的存储桶信息
        Bucket: "******125********" /* 存储桶，必须 */,
        Region: "**-*********" /* 存储桶所在地域，必须字段 */,
        FileName: "demo1.mp4" /* 文件名 */,
        MixFileName: "demo2.mp4" /* 混音视频文件名 */,
      };

      const msgText = document.querySelector("#msg-text");

      /**
       * 提交一个音视频转码任务。（使用转码模版参数方式）
       * AudioSource: 混音音频url
       * 1. 传入资源如果为存储桶文件，需先使用cos.getObjectUrl进行处理
       * 2. 支持网上资源url传入
       */
      async function postTranscode() {
        msgText.innerHTML = "开始...";

        const AkUrl = await cos.getObjectUrl({
          Bucket: config.Bucket,
          Region: config.Region,
          Key: config.MixFileName,
          Sign: true,
        });

        const key = `jobs`; // 固定值，必须
        const host = `${config.Bucket}.ci.${config.Region}.myqcloud.com`;
        const url = `https://${host}/${key}`;
        const body = COS.util.json2xml({
          Request: {
            // 创建任务的Tag：Transcode;是否必传：是
            Tag: "Transcode",
            // 待操作的文件信息;是否必传：是
            Input: {
              // 文件路径;是否必传：是
              Object: config.FileName,
            },
            // 操作规则;是否必传：是
            Operation: {
              // 转码模板参数
              Transcode: {
                Container: {
                  Format: "mp4",
                },
                Video: {
                  Codec: "H.264",
                },
                Audio: {
                  Codec: "aac",
                },
                AudioMix: {
                  AudioSource: AkUrl,
                  Replace: true,
                },
              },
              // 结果输出配置;是否必传：是
              Output: {
                // 存储桶的地域;是否必传：是
                Region: config.Region,
                // 存储结果的存储桶;是否必传：是
                Bucket: config.Bucket,
                // 输出结果的文件名;是否必传：是
                Object: "混音完成的视频.mp4",
              },
            },
          },
        });

        const res = await cos.request({
          Method: "POST", // 固定值，必须
          Key: key, // 必须
          Url: url, // 请求的url，必须
          Body: body, // 请求体参数，必须
          ContentType: "application/xml", // 固定值，必须
        });

        if (res.statusCode === 200) {
          queryTranceTrack(res.Response.JobsDetail.JobId);
        }
      }

      //定时查询音视频转码任务执行结果。https://cloud.tencent.com/document/product/460/84765
      function queryTranceTrack(jobId) {
        setTimeout(() => {
          const key = `jobs/${jobId}`; // jobId: 需要查询的jobId;
          const host = config.Bucket + ".ci." + config.Region + ".myqcloud.com";
          const url = `https://${host}/${key}`;
          cos.request(
            {
              Bucket: config.Bucket,
              Region: config.Region,
              Method: "GET",
              Url: url,
              Key: key /** 固定值，必须 */,
              ContentType: "application/xml" /** 固定值，必须 */,
            },
            async (err, data) => {
              if (err) {
                msgText.innerHTML = "任务查询失败，请在console查看报错信息";
                console.log(JSON.stringify(err));
                return;
              }
              const resp = data.Response || {};
              //判断任务是否在执行中
              if (resp.JobsDetail.State !== "Success") {
                msgText.innerHTML = "任务执行中...";
                queryTranceTrack(jobId);
                return;
              }
              // 任务执行完成 初始化播放器
              msgText.innerHTML = "任务完成";

              const AkUrl = await cos.getObjectUrl({
                Bucket: config.Bucket,
                Region: config.Region,
                Key: resp.JobsDetail.Operation.Output.Object,
                Sign: true,
              });

              // 视频混音后的效果展示
              const changeFile = document.querySelector("#changeFile-id");
              changeFile.src = AkUrl;
              changeFile.controls = true;
            }
          );
        }, 2000);
      }
    </script>
  </body>
</html>
